@page "/review-assessment/{id}"
@using System.Linq
@inject AssessmentService AssessmentService
@inject UserService UserService
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<RadzenCard Style="max-width: 1400px; margin: 2rem auto; padding: 1rem;">
    <RadzenButton Text="Back" Click="BackToAssessmentList" ButtonStyle="ButtonStyle.Light" />
    @if (assessment != null)
    {
    <RadzenHeading Size="H3" Text=@($"Assessment ID {assessment.Id.Substring(0, 3)} for Application {assessment.ApplicationID} Criticality {assessment.Criticality}")
                   style="font-weight: bold; color: #FFFFFF; padding: 10px 20px; margin: 10px 0; text-align: center; background-color: #00436a;" />
    <div style="margin-top: 1rem; padding: 10px; background-color: #f5f5f5; border-radius: 5px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
        <RadzenLabel Text="Assessment Type:" style="font-weight: bold; color: #333; margin-bottom: 5px;" />
        <RadzenTextBox Value="@assessment.AssessmentType" ReadOnly="true" Style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background-color: #fff;" />
    </div>
    
    @if (!string.IsNullOrEmpty(assessment.SolutionDesignImagePath))
    {
    <div class="evidence-container">
        <img src="@assessment.SolutionDesignImagePath"/>
        @foreach (var pin in assessment.Pins)
        {
        @if ((HoverPin != null && HoverPin.CapabilityId == pin.CapabilityId) || (selectedCapability != null && pin.Capability == selectedCapability))
        {
        backgroundColor = "transparent";
        border = "2px solid #FF9900";
        opacity = "1";
        }
        else
        {
        backgroundColor = "#6c757d";
        opacity = "1";
        border = "none";
        }

        @if ((HoverPin != null && HoverPin.CapabilityId != pin.CapabilityId) || (selectedCapability != null && pin.Capability != selectedCapability))
        {
        backgroundColor = "#dcdcdc";
        opacity = ".35";
        border = "none";
        }

        <div style="position: absolute; left:@(pin.X)px; top:@(pin.Y)px; width:@(pin.Width)px; height:@(pin.Height)px; background-color:@backgroundColor; border:@border; opacity:@opacity;border-radius:50%; cursor:default;"
             @onpointerover="() => HoverPin = pin"
             @onpointerout="() => HoverPin = null">
        </div>
        }
        @if (HoverPin != null)
        {
        <div style="position: absolute; left:@(HoverPin.X + TooltipOffsetX)px; top:@(HoverPin.Y - TooltipOffsetY)px; background-color:black; color:white; padding:4px 8px; border-radius:4px; pointer-events:none; white-space:nowrap;">
            @HoverPin.Capability?.CapabilityName
        </div>
        }
    </div>
    }

    <RadzenHeading Size="H4" Text="Capabilities" Style="margin-top:1rem;" />
    
    <RadzenRow Style="margin-bottom:1rem; gap:0.5rem;">
        <RadzenColumn Width="6">
            <RadzenTextBox Placeholder="Search capabilities, evidence…" Style="width:100%;" @bind-Value="globalSearch" Change="@OnFilterChanged">
                <Template>
                    <RadzenIcon Icon="search" Style="margin-left:8px;" />
                </Template>
            </RadzenTextBox>
        </RadzenColumn>
        <RadzenColumn Width="4">
            <RadzenDropDown TValue="string" Data="@subcontrolOptions" Placeholder="Find Sub Contrl ID" AllowClear="true" Style="width:100%;" 
                            AllowFiltering="true"
                            FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                            FilterOperator="StringFilterOperator.Contains"
                            SearchPlaceholder="Type to search…" @bind-Value="selectedSubCtrl" Change="@OnFilterChanged" />
        </RadzenColumn>
    </RadzenRow>

    <div style="flex:1 1 auto; max-height:600px; overflow:auto;">
        <RadzenDataGrid TItem="ReviewRow"
                        Data="@filteredRows"
                        Style="width:100%;"
                        AllowSorting="true">
            <Columns>
                <RadzenDataGridColumn TItem="ReviewRow" Title="SubCtrl" Width="160px" Sortable="false">
                    <Template Context="row">
                        @{
                        capabilityLookup.TryGetValue(row.CapabilityName, out var cap);
                        var css = cap == HoverPin?.Capability || cap == selectedCapability ? "hl" : "";
                        }
                        <div class="cap-cell @css"
                             @onmouseover="() => { if(cap!=null) SelectCapability(cap); }"
                             @onmouseout="ResetSelection">
                            @foreach (var id in row.SubControlIds)
                            {
                            <div>@id</div>
                            }
                        </div>
                    </Template>
                </RadzenDataGridColumn>

                <RadzenDataGridColumn TItem="ReviewRow" Property="CapabilityName" Title="Capability" Width="260px" Sortable="true">
                    <Template Context="row">
                        @{
                        capabilityLookup.TryGetValue(row.CapabilityName, out var cap);
                        var css = cap == HoverPin?.Capability || cap == selectedCapability ? "hl" : "";
                        }
                        <span class="cap-cell @css"
                              @onmouseover="() => { if(cap!=null) SelectCapability(cap); }"
                              @onmouseout="ResetSelection">
                                @row.CapabilityName
                            </span>
                    </Template>
                </RadzenDataGridColumn>

                <RadzenDataGridColumn TItem="ReviewRow" Property="Checked" Title="Fulfilment" Width="95px" Sortable="true">
                    <Template Context="row">
                        @{
                        capabilityLookup.TryGetValue(row.CapabilityName, out var cap);
                        var css = cap == HoverPin?.Capability || cap == selectedCapability ? "hl" : "";
                        }
                        <span class="cap-cell @css"
                              @onmouseover="() => { if(cap!=null) SelectCapability(cap); }"
                              @onmouseout="ResetSelection">
                                @row.Checked
                            </span>
                    </Template>
                </RadzenDataGridColumn>

                <RadzenDataGridColumn TItem="ReviewRow" Property="Evidence" Title="Evidence" Sortable="false">
                    <Template Context="row">
                        @{
                            capabilityLookup.TryGetValue(row.CapabilityName, out var cap);
                            var css        = cap == HoverPin?.Capability || cap == selectedCapability ? "hl" : "";
                            var isExpanded = expandedRows.Contains(row);

                            // decide what text to show
                            var textToShow = row.Evidence;
                            if (!isExpanded && !string.IsNullOrEmpty(row.Evidence) &&
                                row.Evidence.Length > EvidencePreviewLength)
                            {
                                textToShow = row.Evidence.Substring(0, EvidencePreviewLength) + "…";
                            }
                        }

                        <div class="evidence-box cap-cell @css"
                             @onmouseover="() => { if (cap != null) SelectCapability(cap); }"
                             @onmouseout="ResetSelection">
                            @textToShow

                            @if (!string.IsNullOrEmpty(row.Evidence) &&
                                 row.Evidence.Length > EvidencePreviewLength)
                            {
                                <a href="#"
                                   @onclick="(MouseEventArgs _) => ToggleExpansion(row)"
                                   @onclick:preventDefault="true">
                                    @(isExpanded ? "Show less" : "Show more")
                                </a>
                            }
                        </div>
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    </div>
    
    @if (assessment.Status != "Validated" && assessment.Status != "Rejected" && UserService.Role != "Requester")
    {
    <div style="margin-top: 1rem;">
        <RadzenLabel Text="Justification:" />
        <RadzenTextArea @bind-Value="justification" Style="width: 100%;" />
    </div>
    <div style="margin-top: 1rem;">
        <RadzenButton Text="Validate" Click="AcceptAssessment" ButtonStyle="ButtonStyle.Primary" Style="margin-right: 10px;" />
        <RadzenButton Text="Reject" Click="RejectAssessment" ButtonStyle="ButtonStyle.Danger" />
    </div>
    }
    @if (assessment.Status == "Validated" || assessment.Status == "Rejected")
    {
    @if (assessment.Justification != null)
    {
        <div style="margin-top:1rem;">
            <RadzenLabel Text="Justification:" />
            
            <div class="justification-view">
                @assessment.Justification
            </div>
        </div>
    }
    }
    @if (!string.IsNullOrEmpty(errorMessage))
    {
    <RadzenAlert Severity="AlertSeverity.Error" Text="@errorMessage" Style="margin-top:1rem;" />
    }
    }
</RadzenCard>

@code {
[Parameter] public string Id { get; set; }
private Assessment assessment;
private string justification;
private string errorMessage;
private string backgroundColor;
private string border;
private Pin HoverPin;
private int TooltipOffsetX = 35;
private int TooltipOffsetY = 20;
private Capability? selectedCapability;
private string opacity;

private const int EvidencePreviewLength = 120;          
private HashSet<ReviewRow> expandedRows = new();

// --- Filtering state ---
private string globalSearch = string.Empty;
private string selectedSubCtrl;
private List<string> subcontrolOptions = new();

private record ReviewRow(
IReadOnlyList<string> SubControlIds,
string CapabilityName,
string Checked,
string Evidence);

private Dictionary<string, Capability> capabilityLookup = new(StringComparer.OrdinalIgnoreCase);
private IReadOnlyList<ReviewRow> reviewRows = Array.Empty<ReviewRow>();

private IReadOnlyList<ReviewRow> filteredRows => reviewRows
.Where(r => (string.IsNullOrWhiteSpace(globalSearch) ||
r.CapabilityName.Contains(globalSearch, StringComparison.OrdinalIgnoreCase) ||
r.Checked.Contains(globalSearch, StringComparison.OrdinalIgnoreCase) ||
r.Evidence.Contains(globalSearch, StringComparison.OrdinalIgnoreCase) ||
r.SubControlIds.Any(id => id.Contains(globalSearch, StringComparison.OrdinalIgnoreCase))) &&
(string.IsNullOrEmpty(selectedSubCtrl) || r.SubControlIds.Contains(selectedSubCtrl)))
.ToList();

void ToggleExpansion(ReviewRow row)
{
    if (expandedRows.Contains(row))
        expandedRows.Remove(row);
    else
        expandedRows.Add(row);
}


protected override async Task OnInitializedAsync()
{
assessment = await AssessmentService.GetAssessmentByIdAsync(Id);

if (UserService.Role == "Reviewer")
{
if (assessment.Status != "UnderReview" && assessment.Status != "Validated" && assessment.Status != "Rejected")
{
assessment.Status = "UnderReview";
assessment.StartReviewBy = UserService.Email;
assessment.StartReviewAt = DateTime.UtcNow;
await AssessmentService.UpdateAssessmentAsync(assessment);
}
}

reviewRows = assessment.Capabilities
.GroupBy(c => (c.CapabilityName ?? string.Empty).Trim(), StringComparer.OrdinalIgnoreCase)
.Select(g => new ReviewRow(
SubControlIds: g.Select(x => x.SubControlID).Distinct().OrderBy(id => id).ToList(),
CapabilityName: g.Key,
Checked: g.First().Checked ?? string.Empty,
Evidence: g.First().Evidence ?? string.Empty))
.ToList();

capabilityLookup = assessment.Capabilities
.GroupBy(c => (c.CapabilityName ?? string.Empty).Trim(), StringComparer.OrdinalIgnoreCase)
.ToDictionary(g => g.Key, g => g.First(), StringComparer.OrdinalIgnoreCase);

// Distinct SubControl IDs for dropdown filter
subcontrolOptions = reviewRows.SelectMany(r => r.SubControlIds).Distinct().OrderBy(id => id).ToList();
}

private void OnFilterChanged(object value) => StateHasChanged();

private async Task AcceptAssessment()
{
await AssessmentService.ReviewAssessmentAsync(Id, UserService.Email, string.Empty, true);
NavigationManager.NavigateTo("/review", true);
}

private void BackToAssessmentList()
{
NavigationManager.NavigateTo(UserService.Role == "Requester" ? "/assessments" : "/review", true);
}

private async Task RejectAssessment()
{
if (string.IsNullOrEmpty(justification))
{
errorMessage = "Justification is required";
return;
}

await AssessmentService.ReviewAssessmentAsync(Id, UserService.Email, justification, false);
NavigationManager.NavigateTo("/review", true);
}

void SelectCapability(Capability capability)
{
selectedCapability = capability;
}

void ResetSelection() => selectedCapability = null;
}

<style>
    .rz-button.rz-primary.rz-shade-default {
        background-color: #00436a;
    }

    .rz-button.rz-danger.rz-shade-default,
    .rz-button.rz-danger {
        background-color: #f0f7fa;
        color: black;
    }

    :root {
        --rz-on-primary-lighter: #00436a;
        --rz-primary: #00436a;
    }

    .evidence-container {
        position: relative;
        width: 1000px;
        height: 800px;
        border: 1px solid #ccc;
        box-sizing: border-box;
    }

    .evidence-container img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    .hl {
        color: #FF0000;
    }

    .cap-cell {
        white-space: normal;
        word-wrap: break-word;
    }
    
    .evidence-box {
        white-space: normal;     
        overflow-x: visible;      
        max-width: 600px;
    }

    .justification-view {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: #fff;
        white-space: pre-wrap;   
        box-sizing: border-box;  
    }
</style>