@page "/review-assessment/{id}"
@using System.Linq
@using Radzen
@inject IAssessmentService AssessmentService
@inject UserService        UserService
@inject NavigationManager  NavigationManager
@inject RadzenDialog RadzenDialog
@rendermode InteractiveServer

<RadzenCard Style="max-width:1450px;margin:2rem auto;padding:1rem;">
    <RadzenButton Text="Back" ButtonStyle="ButtonStyle.Light" Click="BackToAssessmentList" />

    @if (assessment is not null)
    {
        <div class="info-bar">
            <div><span class="info-label">Assessment&nbsp;ID</span><span>@assessment.Id</span></div>
            <div><span class="info-label">Application&nbsp;ID</span><span>@assessment.ApplicationID</span></div>
            <div><span class="info-label">Type</span><span>@assessment.AssessmentType</span></div>
            <div><span class="info-label">Criticality</span><span>@assessment.Criticality</span></div>
        </div>

        @if (!string.IsNullOrEmpty(assessment.SolutionDesignImagePath))
        {
            <div class="evidence-container">
                <img src="@assessment.SolutionDesignImagePath" />
                @foreach (var p in assessment.Pins)
                {
                    var hot  = (HoverPin?.CapabilityId == p.CapabilityId) || (selectedCapability == p.Capability);
                    var fade = (HoverPin is not null && HoverPin.CapabilityId != p.CapabilityId) ||
                               (selectedCapability is not null && selectedCapability != p.Capability);

                    var bg  = hot ? "transparent" : fade ? "#dcdcdc" : "#000000";
                    var brd = hot ? "6px solid #FF0000" : "none";
                    var op  = fade ? ".35" : "1";

                    <div style="position:absolute;left:@($"{p.X}px");top:@($"{p.Y}px");
                                width:@($"{p.Width}px");height:@($"{p.Height}px");
                                background-color:@bg;border:@brd;opacity:@op;border-radius:50%;"
                         @onpointerover="() => HoverPin = p"
                         @onpointerout ="() => HoverPin = null" />
                }

                @if (HoverPin is not null)
                {
                    <div class="pin-tooltip" style="left:@(HoverPin.X+35)px;top:@(HoverPin.Y-20)px;">
                        @HoverPin.Capability?.CapabilityName
                    </div>
                }
            </div>
        }

        <RadzenRow Style="margin:1rem 0;gap:.5rem;">
            <RadzenColumn Width="6">
                <RadzenTextBox Placeholder="Search capability, evidence…" Style="width:100%;"
                               @bind-Value="search" Change="@(_ => StateHasChanged())">
                    <Template><RadzenIcon Icon="search" Style="margin-left:8px;" /></Template>
                </RadzenTextBox>
            </RadzenColumn>
            <RadzenColumn Width="4">
                <RadzenDropDown TValue="string" Data="@subCtrlOpts" AllowFiltering="true" AllowClear="true"
                                Placeholder="Find SubCtrl ID" Style="width:100%;"
                                @bind-Value="selectedSub" Change="@(_ => StateHasChanged())" />
            </RadzenColumn>
        </RadzenRow>

        @if (rowsWithNotes.Any())
        {
            <RadzenHeading Size="H5" Text="Capabilities with Reviewer Notes"
                           Style="color:#c62828;margin:0.5rem 0;" />

            <RadzenDataGrid TItem="RRow"
                            Data="@rowsWithNotes"
                            ExpandMode="DataGridExpandMode.Multiple"
                            ShowExpandColumn="true"
                            AllowSorting="true"
                            AllowFiltering="false"
                            Class="flagged-grid"
                            Style="width:100%;">
                <Columns>
                    <RadzenDataGridColumn TItem="RRow"
                                          Property="Cluster"
                                          Title="Cluster"
                                          Width="165px" />

                    <RadzenDataGridColumn TItem="RRow" Title="SubCtrl" Width="150px">
                        <Template Context="r">
                            @foreach (var id in r.SubCtrls)
                            {
                                <div class="cap-cell"
                                     @onmouseover="() => Hover(r.CapName)"
                                     @onmouseout="ClearHover">@id</div>
                            }
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="RRow" Title="Capability" Width="300px">
                        <Template Context="r">
                            <div class="cap-cell long-text"
                                 @onmouseover="() => Hover(r.CapName)"
                                 @onmouseout="ClearHover">@r.CapName</div>
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>

                <Template Context="r">
                    <div class="detail-grid">
                        <div class="detail-label">Fulfilment:</div>
                        <div>@r.Checked</div>

                        <div class="detail-label">Evidence:</div>
                        <div class="long-text">@r.Evidence</div>
                    </div>

                    @if (UserService.Role == "Reviewer" && assessment.Status == "UnderReview")
                    {
                        <RadzenTextArea Style="width:100%;min-height:120px"
                                        @bind-Value="r.Comment" />

                        <div style="margin-top:.5rem;text-align:right;">
                            <RadzenButton Text="Save"
                                          Icon="save"
                                          Size="ButtonSize.Small"
                                          ButtonStyle="ButtonStyle.Primary"
                                          Style="margin-right:8px"
                                          Click="@( () => SaveComment(r) )" />

                            <RadzenButton Text="Delete"
                                          Icon="delete"
                                          Size="ButtonSize.Small"
                                          ButtonStyle="ButtonStyle.Danger"
                                          Click="@( () => DeleteComment(r) )" />
                        </div>
                    }
                    else
                    {
                        <div class="comment-readonly">@r.Comment</div>
                    }
                </Template>
            </RadzenDataGrid>
        }

        <div class="cluster-grids">
            @{ var gridIndex = 0; }
            @foreach (var grp in rowsPlain
                                .GroupBy(r => r.Cluster)
                                .OrderBy(g => g.Key.Equals("Platform Security", StringComparison.OrdinalIgnoreCase) ? 0 : 1)
                                .ThenBy(g => g.Key))
            {
                var isFirstClusterGrid = gridIndex++ == 0;

                <RadzenHeading Size="H5" Text="@grp.Key" Style="color:#00436a;margin:1rem 0 0.4rem;" />

                <RadzenDataGrid TItem="RRow"
                                Data="@grp.ToList()"
                                Class=@($"cluster-grid{(isFirstClusterGrid ? " cluster-grid--show-header" : "")}")
                                Style="width:100%;">
                    <Columns>
                        <RadzenDataGridColumn TItem="RRow" Title="SubCtrl" Width="150px">
                            <Template Context="r">
                                <div class="cap-cell" @onmouseover="() => Hover(r.CapName)" @onmouseout="ClearHover">
                                    @foreach (var id in r.SubCtrls)
                                    {
                                        <div>@id</div>
                                    }
                                </div>
                            </Template>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="RRow" Title="Capability" Width="180px">
                            <Template Context="r">
                                <div class="cap-cell long-text cap-wrap"
                                     @onmouseover="() => Hover(r.CapName)" @onmouseout="ClearHover">
                                    @r.CapName

                                    @if (assessment.Status == "UnderReview")
                                    {
                                        <RadzenButton Icon="comment"
                                                      Size="ButtonSize.Small"
                                                      ButtonStyle="ButtonStyle.Light"
                                                      Style="position:absolute;right:4px;top:2px;"
                                                      Click="() => EditComment(r)" />
                                    }
                                </div>
                            </Template>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="RRow" Property="Checked"
                                              Title="Fulfilment" Width="210px" />

                        <RadzenDataGridColumn TItem="RRow" Title="Evidence">
                            <Template Context="r">
                                <div class="cap-cell long-text"
                                     @onmouseover="() => Hover(r.CapName)" @onmouseout="ClearHover">@r.Evidence</div>
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
            }
        </div>

        @if (assessment.Status is not ("Validated" or "Rejected") && UserService.Role != "Requester")
        {
            <div style="margin-top:1rem;">
                <RadzenLabel Text="Justification:" />
                <RadzenTextArea @bind-Value="justification" Style="width:100%;" />
            </div>
            <div style="margin-top:1rem;">
                <RadzenButton Text="Validate" ButtonStyle="ButtonStyle.Primary"
                              Style="margin-right:10px;" Click="Accept" />
                <RadzenButton Text="Reject" ButtonStyle="ButtonStyle.Danger" Click="Reject" />
            </div>
        }

        @if ((assessment.Status == "Validated" || assessment.Status == "Rejected")
             && !string.IsNullOrWhiteSpace(assessment.Justification))
        {
            <RadzenHeading Size="H5" Text="Reviewer Justification" Style="margin-top:1rem;" />
            <div class="justification-view">@assessment.Justification</div>
        }

        @if (!string.IsNullOrEmpty(errorMsg))
        {
            <RadzenAlert Severity="AlertSeverity.Error" Text="@errorMsg" Style="margin-top:1rem;" />
        }
    }

    @if (commentDialogVisible && editingRow is not null)
    {
        <div class="modal-backdrop" @onclick="CancelComment"></div>

        <div class="comment-dialog">
            <RadzenCard Style="width:500px;max-width:90vw;padding:1rem;">
                <h4 style="margin:0 0 .5rem 0">Reviewer comment</h4>

                <RadzenTextArea Style="width:100%;min-height:120px"
                                @bind-Value="editingRow!.Comment" />

                <div style="margin-top:1rem;text-align:right;">
                    <RadzenButton Text="Save"
                                  ButtonStyle="ButtonStyle.Primary"
                                  Style="margin-right:8px"
                                  Click="@(() => SaveComment(editingRow))" />
                    <RadzenButton Text="Cancel"
                                  ButtonStyle="ButtonStyle.Secondary"
                                  Click="@CancelComment" />
                </div>
            </RadzenCard>
        </div>
    }
</RadzenCard>

@code {
    private class RRow
    {
        public string Cluster    { get; init; }
        public List<string> SubCtrls { get; init; }
        public string CapName    { get; init; }
        public string Checked    { get; init; }
        public string Evidence   { get; init; }
        public string Comment    { get; set; }
        public bool   ShowComment { get; set; }
    }

    [Parameter] public string Id { get; set; }

    private Assessment assessment;
    private string justification;
    private string errorMsg;

    private Pin HoverPin;
    private Capability selectedCapability;
    private void Hover(string cap) => selectedCapability = capDict.TryGetValue(cap, out var c) ? c : null;
    private void ClearHover()      => selectedCapability = null;

    private string search = "";
    private string selectedSub;
    private List<string> subCtrlOpts = new();

    private List<RRow> rows = new();
    private Dictionary<string, Capability> capDict = new(StringComparer.OrdinalIgnoreCase);

    private IEnumerable<RRow> filtered =>
        rows.Where(r =>
            (string.IsNullOrWhiteSpace(search)
             || r.CapName.Contains(search, StringComparison.OrdinalIgnoreCase)
             || r.Checked.Contains(search, StringComparison.OrdinalIgnoreCase)
             || r.Evidence.Contains(search, StringComparison.OrdinalIgnoreCase)
             || r.SubCtrls.Any(id => id.Contains(search, StringComparison.OrdinalIgnoreCase)))
            && (string.IsNullOrEmpty(selectedSub) || r.SubCtrls.Contains(selectedSub)));

    private IEnumerable<RRow> rowsWithNotes => filtered.Where(r => !string.IsNullOrWhiteSpace(r.Comment));
    private IEnumerable<RRow> rowsPlain     => filtered.Where(r =>  string.IsNullOrWhiteSpace(r.Comment));
    private bool commentDialogVisible;
    private RRow  editingRow;
    protected override async Task OnInitializedAsync()
    {
        assessment = await AssessmentService.GetAssessmentByIdAsync(Id);

        if (UserService.Role == "Reviewer" && assessment.Status == "Submitted")
        {
            assessment.Status        = "UnderReview";
            assessment.StartReviewBy = UserService.Email;
            assessment.StartReviewAt = DateTime.UtcNow;
            await AssessmentService.UpdateAssessmentAsync(assessment);
        }

        rows = assessment.Capabilities
            .GroupBy(c => new { c.Cluster, c.CapabilityName })
            .Select(g => new RRow
            {
                Cluster    = g.Key.Cluster ?? "",
                SubCtrls   = g.Select(x => x.SubControlID).Where(x => x != null).Distinct().ToList(),
                CapName    = g.Key.CapabilityName ?? "",
                Checked    = g.Select(x => x.Checked).FirstOrDefault(x => !string.IsNullOrEmpty(x)) ?? "",
                Evidence   = g.Select(x => x.Evidence).FirstOrDefault(x => !string.IsNullOrEmpty(x)) ?? "",
                Comment    = g.Select(x => x.ReviewerComment).FirstOrDefault(x => !string.IsNullOrEmpty(x)),
                ShowComment = false
            })
            .ToList();

        capDict = assessment.Capabilities
                   .GroupBy(c => c.CapabilityName ?? "", StringComparer.OrdinalIgnoreCase)
                   .ToDictionary(g => g.Key, g => g.First(), StringComparer.OrdinalIgnoreCase);

        subCtrlOpts = rows.SelectMany(r => r.SubCtrls).Distinct().OrderBy(x => x).ToList();
    }

    async void EditComment(RRow row)
    {
        editingRow           = row;
        commentDialogVisible = true;
    }

    async Task SaveComment(RRow row)
    {
        if (capDict.TryGetValue(row.CapName, out var cap))
            cap.ReviewerComment = row.Comment?.Trim();

        await AssessmentService.UpdateAssessmentAsync(assessment);
        commentDialogVisible = false;
        StateHasChanged();
    }

    async Task DeleteComment(RRow row)
    {
        row.Comment = null;
        if (capDict.TryGetValue(row.CapName, out var cap))
            cap.ReviewerComment = null;

        await AssessmentService.UpdateAssessmentAsync(assessment);
        StateHasChanged();
    }

    void CancelComment()
    {
        commentDialogVisible = false;
        editingRow           = null;
    }

    private void OnCommentChanged(RRow row, object _)
    {
        if (capDict.TryGetValue(row.CapName, out var cap))
            cap.ReviewerComment = row.Comment?.Trim();
    }

    private async Task Accept()
    {
        await AssessmentService.UpdateAssessmentAsync(assessment);
        await AssessmentService.ReviewAssessmentAsync(Id, UserService.Email, string.Empty, true);
        NavigationManager.NavigateTo("/review", true);
    }

    private async Task Reject()
    {
        if (string.IsNullOrWhiteSpace(justification)) { errorMsg = "Justification required"; return; }
        await AssessmentService.UpdateAssessmentAsync(assessment);
        await AssessmentService.ReviewAssessmentAsync(Id, UserService.Email, justification, false);
        NavigationManager.NavigateTo("/review", true);
    }

    private void BackToAssessmentList()
    {
        var targetUrl = UserService.Role switch
        {
            "Requester" => "/assessments",
            "Reviewer"  => "/review",
            "Admin"     => "/admin/assessments",
            _           => "/"
        };

        NavigationManager.NavigateTo(targetUrl, true);
    }
}

<style>
:root{--rz-primary:#00436a;}

.evidence-container{position:relative;width:1000px;height:800px;border:1px solid #ccc;margin-top:1rem;}
.evidence-container img{width:100%;height:100%;object-fit:contain;}
.pin-tooltip{position:absolute;background:#000;color:#fff;padding:4px 8px;border-radius:4px;font-size:.8rem;white-space:nowrap;pointer-events:none;}

.long-text{white-space:pre-wrap;word-break:break-word;}
.comment-readonly{white-space:pre-wrap;word-break:break-word;padding:8px 4px;}
.justification-view{white-space:pre-wrap;word-break:break-word;padding:10px;border:1px solid #ddd;border-radius:4px;background:#fff;}

.cap-cell:hover{background:rgba(255,248,225,.6);}
.flagged-grid .rz-datagrid-cell{background:#fff7e6;}
.flagged-grid .rz-datagrid-header{background:#ffe0b2;font-weight:600;}

.rz-button.rz-primary.rz-shade-default{background:#00436a;}
.rz-button.rz-danger.rz-shade-default,
.rz-button.rz-danger{background:#f0f7fa;color:#000;}

.info-bar{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));
          gap:1rem;margin:1.4rem 0;border:1px solid #e0e0e0;border-radius:8px;
          background:#EBEBE6;padding:1rem;}
.info-bar>div{display:flex;flex-direction:column;gap:.15rem;}
.info-label{font-size:.78rem;font-weight:700;color:#555;}
.cluster-grids .cluster-grid .rz-datagrid-header,
.cluster-grids .cluster-grid thead {
    display: none !important;
}

.cluster-grids .cluster-grid.cluster-grid--show-header .rz-datagrid-header {
    display: block !important;
}
.cluster-grids .cluster-grid.cluster-grid--show-header thead {
    display: table-header-group !important; 
}
.cap-wrap{position:relative;padding-right:26px;}
.modal-backdrop{
    position:fixed; inset:0;
    background:rgba(0,0,0,.55);
    z-index:1100;
}
.comment-dialog{
    position:fixed;
    left:50%; top:50%;
    transform:translate(-50%,-50%);
    z-index:1200;
}
.flagged-grid .rz-data-grid-expand-cell { width:42px; }

.detail-grid{
    display:grid;
    grid-template-columns:110px auto;
    gap:.25rem .75rem;
    padding-bottom:.75rem;
}
.detail-label{
    font-weight:600;
    color:#555;
}
</style>
