@page "/assessments"
@rendermode InteractiveServer
@inject AssessmentService AssessmentService
@inject UserService UserService
@inject NavigationManager NavigationManager

<div class="rz-main-container">
    <RadzenButton Text="Home" Click="BackToHome" ButtonStyle="ButtonStyle.Light" />
    <RadzenHeading Size="H3" Text="My Assessments" />
    <RadzenButton Text="Create New Assessment" Click="CreateNewAssessment" ButtonStyle="ButtonStyle.Primary" Style="margin-bottom: 1rem;" />
    @if (string.IsNullOrEmpty(UserService.Email))
    {
        <RadzenAlert Severity="AlertSeverity.Warning" Text="Please log in first." />
    }
    else if (UserService.Role != "Requester")
    {
        <RadzenAlert Severity="AlertSeverity.Error" Text="You are not authorized to view this page." />
    }
    else
    {
        if (assessments != null)
        {
            <RadzenCard Style="margin-bottom: 1rem;">
                <RadzenHeading Size="H4" Text="Active Assessments" />
                <RadzenDataGrid TItem="Assessment" Data="@assessments.Where(a => a.Status == "Draft")" Style="margin-top: 1rem;">
                    <Columns>
                        <RadzenDataGridColumn TItem="Assessment" Title="ID">
                            <Template Context="assessment">
                                @assessment.Id.Substring(0, 3)
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="Assessment" Property="AssessmentType" Title="Type" />
                        <RadzenDataGridColumn TItem="Assessment" Property="ApplicationID" Title="Application ID" />
                        <RadzenDataGridColumn TItem="Assessment" Title="Created At">
                            <Template Context="assessment">
                                @assessment.CreateAt.ToString("yyyy-MM-dd")
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="Assessment" Title="Actions">
                            <Template Context="assessment">
                                <RadzenButton Text="Edit" Click="@(args => EditAssessment(assessment.Id))" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" />
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
            </RadzenCard>
            <RadzenCard>
                <RadzenHeading Size="H4" Text="Submitted Assessments" />
                <RadzenDataGrid TItem="Assessment" Data="@assessments.Where(a => a.Status != "Draft")" Style="margin-top: 1rem;">
                    <Columns>
                        <RadzenDataGridColumn TItem="Assessment" Title="ID">
                            <Template Context="assessment">
                                @assessment.Id.Substring(0, 3)
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="Assessment" Property="AssessmentType" Title="Type" />
                        <RadzenDataGridColumn TItem="Assessment" Property="ApplicationID" Title="Application ID" />
                        <RadzenDataGridColumn TItem="Assessment" Property="Status" Title="Status" />
                        <RadzenDataGridColumn TItem="Assessment" Title="Submitted At">
                            <Template Context="assessment">
                                @assessment.SubmittedAt?.ToString("yyyy-MM-dd")
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="Assessment" Title="Duration">
                            <Template Context="assessment">
                                @((int)(assessment.SubmittedAt - assessment.CreateAt).Value.TotalHours) hours
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="Assessment" Title="Actions">
                            <Template Context="assessment">
                                <RadzenButton Text="Review" Click="@(args => EditAssessment(assessment.Id))" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" />
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
            </RadzenCard>
        }
    }
</div>

@code {
    private List<Assessment> assessments;
    
    protected override async Task OnInitializedAsync()
    {
        if (UserService.Role == "Requester")
        {
            assessments = await AssessmentService.GetAssessmentsByEmailAsync(UserService.Email);
        }
    }
    
    private void CreateNewAssessment() => NavigationManager.NavigateTo("/create-assessment", true);
    
    private async Task EditAssessment(string id)
    {
        var assessment = await AssessmentService.GetAssessmentByIdAsync(id);
        if (assessment.Status != "Accepted" && assessment.Status != "Rejected" && assessment.Status != "Submitted" && assessment.Status != "UnderReview")
        {
            NavigationManager.NavigateTo($"/edit-assessment/{id}", true);
        }
        else
        {
            NavigationManager.NavigateTo($"/review-assessment/{id}", true);
        }
    }
    
    private void BackToHome() => NavigationManager.NavigateTo("/", true);
}