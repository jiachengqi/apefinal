@page "/edit-assessment/{Id}"
@using apenew.Helper
@inject AssessmentService  AssessmentService
@inject UserService        UserService
@inject NavigationManager  NavigationManager
@inject IJSRuntime         JS
@rendermode InteractiveServer

<RadzenCard class="page-card">
    <!-- top bar -->
    <div class="title-bar">
        <RadzenButton Text="Back"
                      ButtonStyle="ButtonStyle.Light"
                      Click="BackToAssessmentList" />

        <RadzenButton Text="Upload Solution Design"
                      ButtonStyle="ButtonStyle.Primary"
                      Click="UploadSolutionDesign" />
    </div>

    <!-- hidden file input -->
    <InputFile @ref="hiddenFile"
               OnChange="HandleFileSelected"
               accept="image/jpeg,image/png"
               style="display:none;" />

    @if (assessment is null)
    {
        <p>Loading…</p>
    }
    else
    {
        <!-- summary -->
        <div class="info-bar">
            <div><span class="info-label">Assessment&nbsp;ID</span><span>@assessment.Id</span></div>
            <div><span class="info-label">Application&nbsp;ID</span><span>@assessment.ApplicationID</span></div>
            <div><span class="info-label">Type</span><span>@assessment.AssessmentType</span></div>
            <div><span class="info-label">Criticality</span><span>@assessment.Criticality</span></div>
        </div>

        <!-- evidence -->
        <div class="evidence-row">
            @if (assessment.SolutionDesignImagePath is not null)
            {
                <div class="evidence-row">
                    <div class="evidence-container">
                        <img src="@assessment.SolutionDesignImagePath"
                             class="resizable-image unselectable"
                             draggable="false" />
                        @foreach (var pin in assessment.Pins)
                        {
                            <DraggablePin X="@pin.X" Y="@pin.Y" Width="20" Height="20"
                                          OnDragEnd="coords => UpdatePinPosition(pin, coords)">
                                <div class="pin-normal">@pin.DisplayNumber</div>
                            </DraggablePin>
                        }
                    </div>

                    <div class="pin-panel">
                        <RadzenDataGrid TItem="GroupedPin"
                                        Data="@groupedPins"
                                        @ref="pinsGrid"
                                        AllowPaging="false"
                                        Style="width:100%;height:100%;">
                            <Columns>
                                <RadzenDataGridColumn TItem="GroupedPin"
                                                      Property="CapabilityName"
                                                      Title="Capability"
                                                      Width="230px" />
                                <RadzenDataGridColumn TItem="GroupedPin" Title="Pins" Width="70px">
                                    <Template Context="grp">
                                        @foreach (var p in grp.Pins)
                                        {
                                            <div class="pin-row">
                                                <span class="pin-no">#@p.DisplayNumber</span>
                                                <RadzenButton Icon="close"
                                                              ButtonStyle="ButtonStyle.Danger"
                                                              Size="ButtonSize.ExtraSmall"
                                                              Style="padding:0;width:20px;height:20px;"
                                                              Click="async _ => await RemovePin(p)" />
                                            </div>
                                        }
                                    </Template>
                                </RadzenDataGridColumn>
                            </Columns>
                        </RadzenDataGrid>
                    </div>
                </div>
            }
        </div>

        <!-- capabilities (unchanged) -->
        @if (groupedCapabilities is null)
        {
            <p>Loading capabilities…</p>
        }
        else
        {
            <RadzenTabs Change="@OnChange"
                        TabPosition="TabPosition.Top"
                        RenderMode="TabRenderMode.Client">
                <Tabs>
                    @foreach (var clusterGroup in groupedCapabilities.OrderBy(c => c.Cluster, StringComparer.OrdinalIgnoreCase))
                    {
                        <RadzenTabsItem Text="@clusterGroup.Cluster">
                            <RadzenAccordion Multiple="true">
                                <Items>
                                    @foreach (var capGroup in clusterGroup.Capabilities.OrderBy(cg => cg.CapabilityName, StringComparer.OrdinalIgnoreCase))
                                    {
                                        <RadzenAccordionItem Text="@capGroup.CapabilityName">
                                            <div class="d-flex align-items-center mb-2 line-inputs">
                                                <RadzenDropDown @bind-Value="capGroup.UiChecked"
                                                                Data="@(new[]{ "Fulfilled","Unfulfilled"})"
                                                                Placeholder="Fulfilment"
                                                                AllowClear="false"
                                                                Style="width:130px;" />

                                                <RadzenTextArea @bind-Value="capGroup.UiEvidence"
                                                                Placeholder="@(capGroup.UiChecked == "Unfulfilled" ? "Justification why this capability is not met" : "How does it meet this capability? (e.g., configs, logs, Confluence links)")"
                                                                Style="flex:1 1 300px; height:38px; min-height:38px; resize:vertical;" />

                                                <RadzenButton Text="Add Pin"
                                                              ButtonStyle="ButtonStyle.Primary"
                                                              Size="ButtonSize.Small"
                                                              Click="() => AddPinForCapability(capGroup.Items.First())" />

                                                <RadzenButton Text="@(IsGroupDescriptionVisible(capGroup.CapabilityName) ? "Show Details" : "Hide Details")"
                                                              ButtonStyle="ButtonStyle.Secondary"
                                                              Size="ButtonSize.Small"
                                                              Click="() => ToggleGroupDescription(capGroup.CapabilityName)" />
                                            </div>

                                            <ul class="list-unstyled p-0">
                                                @foreach (var sub in capGroup.Items)
                                                {
                                                    <li>
                                                        @if (!IsGroupDescriptionVisible(capGroup.CapabilityName))
                                                        {
                                                            <div class="mt-2 p-2 bg-light rounded">
                                                                @sub.SubcontrolDescription
                                                            </div>
                                                        }
                                                    </li>
                                                }
                                            </ul>
                                        </RadzenAccordionItem>
                                    }
                                </Items>
                            </RadzenAccordion>
                        </RadzenTabsItem>
                    }
                </Tabs>
            </RadzenTabs>
        }

        <!-- save / submit -->
        <div style="margin-top:1rem;">
            <RadzenButton Text="Save"
                          ButtonStyle="ButtonStyle.Primary"
                          Click="SaveAssessment"
                          Style="margin-right:10px;" />
            <RadzenButton Text="Submit"
                          ButtonStyle="ButtonStyle.Success"
                          Click="SubmitAssessment" />
        </div>

        @if (!string.IsNullOrWhiteSpace(errorMessage))
        {
            <RadzenAlert Severity="AlertSeverity.Error"
                         Text="@errorMessage"
                         Style="margin-top:1rem;" />
        }
    }
</RadzenCard>

<script>window.triggerClick = el => el && el.click();</script>

@code {
    [Parameter] public string Id { get; set; }
    
    private Assessment assessment;
    private string errorMessage;
    private RadzenDataGrid<GroupedPin> pinsGrid;
    private IEnumerable<GroupedPin> groupedPins;
    private List<GroupedCapabilitiesByCluster> groupedCapabilities;
    private readonly Dictionary<string,bool> showGroupDescriptions = new();
    private int currentTabIndex;
    private InputFile hiddenFile;     
    
    private class GroupedPin
    {
        public string CapabilityName { get; set; }
        public List<Pin> Pins         { get; set; }
    }
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            assessment = await AssessmentService.GetAssessmentByIdAsync(Id);
            ReassignPinNumbers();
            GroupPinsByCapability();
            GroupCapabilitiesByCluster();
        }
        catch (Exception ex) { errorMessage = ex.Message; }
    }
    
    private async Task UploadSolutionDesign() =>
        await JS.InvokeVoidAsync("triggerClick", hiddenFile.Element);

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            if (file is null) return;

            var name = $"{Guid.NewGuid()}{Path.GetExtension(file.Name)}";
            var path = Path.Combine("wwwroot","uploads",name);
            Directory.CreateDirectory(Path.GetDirectoryName(path)!);

            await using var fs = new FileStream(path,FileMode.Create);
            await file.OpenReadStream().CopyToAsync(fs);
            assessment.SolutionDesignImagePath = $"/uploads/{name}";
        }
        catch (Exception ex) { errorMessage = $"Error uploading file: {ex.Message}"; }
    }
    
    private void GroupCapabilitiesByCluster() =>
        groupedCapabilities = CapabilityGrouper.GroupByClusterThenName(assessment.Capabilities);

    private void GroupPinsByCapability() =>
        groupedPins = assessment.Pins
            .GroupBy(p => p.CapabilityId)
            .Select(g => new GroupedPin { CapabilityName = g.First().Capability.CapabilityName, Pins = g.ToList() })
            .ToList();

    private async Task AddPinForCapability(Capability cap)
    {
        var pin = new Pin{ Id = Guid.NewGuid().ToString(), AssessmentId = assessment.Id,
                           CapabilityId = cap.Id, Capability = cap, X = 100, Y = 100, Width = 20, Height = 20 };
        assessment.Pins.Add(pin);
        ReassignPinNumbers();
        GroupPinsByCapability();
        await pinsGrid.Reload();
    }

    private async Task RemovePin(Pin pin)
    {
        assessment.Pins.Remove(pin);
        ReassignPinNumbers();
        GroupPinsByCapability();
        await pinsGrid.Reload();
    }

    private void UpdatePinPosition(Pin p,(double X,double Y) c){ p.X = c.X; p.Y = c.Y; }

    private void ReassignPinNumbers()
    {
        for (int i = 0; i < assessment.Pins.Count; i++)
            assessment.Pins[i].DisplayNumber = i + 1;
    }

    private void ToggleGroupDescription(string name) =>
        showGroupDescriptions[name] = !IsGroupDescriptionVisible(name);

    private bool IsGroupDescriptionVisible(string name) =>
        showGroupDescriptions.TryGetValue(name,out var v) && v;

    private void OnChange(int idx) => currentTabIndex = idx;
    private void BackToAssessmentList() => NavigationManager.NavigateTo("/assessments",true);

    private async Task SaveAssessment()
    {
        try   { await AssessmentService.UpdateAssessmentAsync(assessment); errorMessage = "Saved."; }
        catch (Exception ex) { errorMessage = ex.Message; }
    }

    private async Task SubmitAssessment()
    {
        try
        {
            await AssessmentService.UpdateAssessmentAsync(assessment);
            await AssessmentService.SubmitAssessmentAsync(assessment.Id,UserService.Email);
            NavigationManager.NavigateTo("/assessments",true);
        }
        catch (Exception ex) { errorMessage = ex.Message; }
    }
}

<style>
:root{ --indigo:#00436a; }
.page-card{ max-width:1420px;margin:2rem auto;padding:1.4rem;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,.08); }
.title-bar{ display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem; }
.info-bar{ display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;margin:1.2rem 0;border:1px solid #e0e0e0;border-radius:8px;background:#f7f7f9;padding:1rem; }
.info-bar>div{ display:flex;flex-direction:column;gap:.15rem; }
.info-label{ font-size:.78rem;font-weight:700;color:#555; }
.evidence-row{ display:flex;gap:1rem;overflow-x:auto; }
.evidence-container{ position:relative;width:1000px;height:800px;border:1px solid #ccc;border-radius:8px; }
.resizable-image{ position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain; }
.pin-normal{ width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#2255ff;color:#fff;font-weight:700; }
.pin-panel{ width:320px;height:800px;display:flex;flex-direction:column; }
.pin-row{ display:flex;align-items:center;gap:.35rem;margin-bottom:.35rem; }
.pin-no{ width:34px;text-align:right;font-weight:600; }
.line-inputs{ display:flex;flex-wrap:wrap;gap:.75rem;margin-bottom:.75rem; }
.rz-button.rz-primary.rz-shade-default{ background:var(--indigo); }
.pin-normal {
    background-color: #002337;
}

.unselectable {
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    -o-user-select: none;
}

.rz-button.rz-primary.rz-shade-default {
    background-color: #00436a;
}

.rz-button.rz-success.rz-shade-default {
    background-color: #006db9;
}

.rz-button.rz-secondary.rz-shade-default {
    background-color: #00436a;
}

.rz-button.rz-success {
    background-color: #006db9;
}

.rz-button.rz-danger.rz-shade-default {
    background-color: #f0f7fa;
    color: black;
}

.rz-button.rz-danger {
    background-color: #f0f7fa;
    color: black;
}

.rz-tabview-title {
    color: #00436a;
}

.rz-tabview.rz-tabview-top > .rz-tabview-nav .rz-tabview-selected {
    border-bottom: 2px solid #00436a;
}

:root {
    --rz-on-primary-lighter: #00436a;
    --rz-primary: #00436a;
}


.resizable-image {
    display: block;
    width: 100%;
    height: 100%;
    object-fit: contain;
}

.pin-normal {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #002337;
    color: white;
    font-weight: bold;
    user-select: none;
}

.rz-datagrid-cell {
    white-space: normal;
    word-wrap: break-word;
}


.unselectable {
    user-select: none;
}

.rz-datagrid-cell           { white-space: normal; word-wrap: break-word; }

.pin-row                    { display:flex; align-items:center; }
.pin-no  {            
    display:inline-block;
    width:42px;          
    text-align:right;
    margin-right:4px;
}

.evidence-row {
    display: flex;
    gap: 1rem;        
    flex-wrap: nowrap;  
    overflow-x: auto;   
}


.evidence-container {
    position: relative;
    width: 1000px;      
    height: 800px;
    border: 1px solid #ccc;
    box-sizing: border-box;
}
.evidence-container img {
    width: 100%;
    height: 100%;
    object-fit: contain;
}


.pin-panel {
    width: 320px;
    height: 800px;      
    display: flex;
    flex-direction: column;
}

.line-inputs {
    gap: 1rem;         
}

.info-bar{ display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));
    gap:1rem;margin:1.4rem 0;border:1px solid #e0e0e0;border-radius:8px;
    background: #EBEBE6 ;padding:1rem; }
.info-bar>div{ display:flex;flex-direction:column;gap:.15rem; }
.info-label{ font-size:.78rem;font-weight:700;color:#555; }

</style>
