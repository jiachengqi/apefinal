@page "/edit-assessment/{Id}"
@inject AssessmentService AssessmentService
@inject UserService UserService
@inject NavigationManager NavigationManager
@inject IJSRuntime JS
@rendermode InteractiveServer

<RadzenCard Style="max-width: 1400px; margin: 2rem auto; padding: 1rem;">
    <RadzenButton Text="Back" Click="BackToAssessmentList" ButtonStyle="ButtonStyle.Light" />
    @if (assessment == null)
    {
        <p>Loading...</p>
    }
    else
    {
        <RadzenHeading Size="H3" Text=@($"Assessment ID {assessment.Id.Substring(0, 3)} for Application {assessment.ApplicationID}")
                       style="font-weight: bold; color: #FFFFFF; padding: 10px 20px; margin: 10px 0; text-align: center; background-color: #00436a;" />
        <div style="margin-top: 1rem; padding: 10px; background-color: #f5f5f5; border-radius: 5px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
            <RadzenLabel Text="Assessment Type:" style="font-weight: bold; color: #333; margin-bottom: 5px;" />
            <RadzenTextBox Value="@assessment.AssessmentType" ReadOnly="true" Style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background-color: #fff;" />
        </div>
        <div style="margin-top: 1rem;">
            <RadzenLabel Text="Upload Solution Design Evidence (JPG/PNG):" />
            <InputFile OnChange="HandleFileSelected" accept="image/jpeg,image/png" />
        </div>
        @if (assessment?.SolutionDesignImagePath != null)
        {
            <div 
                @ref="imageContainer" 
                class="resizable-image-container" 
                style="width:@(ImageWidth)px; height:@(ImageHeight)px;">
                <img 
                    src="@assessment.SolutionDesignImagePath" 
                    class="resizable-image unselectable" 
                    draggable="false" />

                @foreach (var pin in assessment.Pins)
                {
                    <DraggablePin 
                        X="@pin.X" 
                        Y="@pin.Y" 
                        Width="20" 
                        Height="20" 
                        OnDragEnd="(coords) => UpdatePinPosition(pin, coords)">
                        <div class="pin-normal">@pin.DisplayNumber</div>
                    </DraggablePin>
                }
            </div>
        }
        <RadzenHeading Size="H4" Text="Pins List" Style="margin-top: 1rem;" />
        <RadzenDataGrid TItem="GroupedPin" Data="@groupedPins" @ref="pinsGrid">
            <Columns>
                <RadzenDataGridColumn TItem="GroupedPin" Property="CapabilityName" Title="Capability Name" />
                <RadzenDataGridColumn TItem="GroupedPin" Title="Pins">
                    <Template Context="group">
                        @foreach (var pin in group.Pins)
                        {
                            <div>
                                Pin #: @pin.DisplayNumber
                                <RadzenButton Text="Remove" Click="@(async args => await RemovePin(pin))" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" />
                            </div>
                        }
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
        
        <RadzenHeading Size="H4" Text="Capabilities" Style="margin-top: 1rem;" />
        @if (groupedCapabilities == null)
        {
            <p>Loading capabilities...</p>
        }
        else
        {
            <RadzenTabs Change="@OnChange" TabPosition="TabPosition.Top" RenderMode="TabRenderMode.Client">
                <Tabs>
                    @foreach (var fieldGroup in groupedCapabilities)
                    {
                        <RadzenTabsItem Text="@fieldGroup.Field">
                            <RadzenAccordion Multiple="true">
                                <Items>
                                    @foreach (var domainGroup in fieldGroup.Domains)
                                    {
                                        <RadzenAccordionItem Text="@domainGroup.Domain" Icon="info">
                                            @foreach (var cap in domainGroup.Capabilities)
{
    bool disableCapability = cap.DanskeBankImplementation != null &&
        (cap.DanskeBankImplementation.Equals("No", StringComparison.OrdinalIgnoreCase) ||
         cap.DanskeBankImplementation.Equals("Not available", StringComparison.OrdinalIgnoreCase));

    <div style="margin-bottom:10px; padding:5px; border-bottom:1px solid #ddd; @(disableCapability ? "background-color: #d3d3d3;" : "")">
        <div style="display: flex; align-items: center;">
            <strong>
                @cap.Control - @cap.SubControlID:
            </strong>
            <span style="margin-left: 5px;">
                @cap.CapabilityName @(string.IsNullOrEmpty(cap.DanskeBankImplementation) ? string.Empty : $"({cap.DanskeBankImplementation})")
            </span>
            
            @if (!string.IsNullOrWhiteSpace(cap.SubcontrolDescription))
            {
                <RadzenButton Icon="@(IsDescriptionVisible(cap.Id) ? "expand_less" : "expand_more")"
                              ButtonStyle="ButtonStyle.Secondary"
                              Size="ButtonSize.Small"
                              Click="@(args => ToggleDescription(cap.Id))"
                              Style="margin-left: 10px;" />
            }
        </div>
        
        @if (!disableCapability)
        {
            <div style="display: flex; align-items: center; margin-top: 5px;">
                <RadzenDropDown @bind-Value="cap.Checked"
                                Data="@(new List<string>{ "", "fulfilled", "unfulfilled" })"
                                Style="width: 100px; flex-shrink: 0;" />
                <RadzenTextBox @bind-Value="cap.Evidence"
                               Style="flex-grow: 1; margin-left: 10px;" />
                <RadzenButton Text="Add Pin"
                              Click="@(async args => await AddPinForCapability(cap))"
                              ButtonStyle="ButtonStyle.Primary"
                              Size="ButtonSize.Small"
                              Style="margin-left: 10px;" />
            </div>
        }

        @* Render the SubcontrolDescription details if toggled visible *@
        @if (IsDescriptionVisible(cap.Id))
        {
            <div style="margin-top: 5px; background-color: #f0f0f0; padding: 5px; border-radius: 5px;">
                @cap.SubcontrolDescription
            </div>
        }
    </div>
}

                                        </RadzenAccordionItem>
                                    }
                                </Items>
                            </RadzenAccordion>
                        </RadzenTabsItem>
                    }
                </Tabs>
            </RadzenTabs>
        }

        <div style="margin-top: 1rem;">
            <RadzenButton Text="Save" Click="SaveAssessment" ButtonStyle="ButtonStyle.Primary" Style="margin-right: 10px;" />
            <RadzenButton Text="Submit" Click="SubmitAssessment" ButtonStyle="ButtonStyle.Success" />
        </div>
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <RadzenAlert Severity="AlertSeverity.Error" Text="@errorMessage" Style="margin-top:1rem;" />
        }
    }
</RadzenCard>

@code {
    [Parameter] public string Id { get; set; }
    private Assessment assessment;
    private string errorMessage;
    private RadzenDataGrid<GroupedPin> pinsGrid;
    private IEnumerable<GroupedPin> groupedPins;
    private List<GroupedCapabilitiesByField> groupedCapabilities;
    private int currentTabIndex = 0;
    private double ImageWidth;
    private double ImageHeight;
    private ElementReference imageContainer;
    private DotNetObjectReference<EditAssessment>? dotNetRef;
    
    private Dictionary<string, bool> showDescriptions = new Dictionary<string, bool>();
    
    private void ToggleDescription(string capId)
    {
        if (showDescriptions.ContainsKey(capId))
        {
            showDescriptions[capId] = !showDescriptions[capId];
        }
        else
        {
            showDescriptions[capId] = true;
        }
    }

    private bool IsDescriptionVisible(string capId)
    {
        return showDescriptions.ContainsKey(capId) && showDescriptions[capId];
    }


    protected override async Task OnInitializedAsync()
    {
        try
        {
            assessment = await AssessmentService.GetAssessmentByIdAsync(Id);
            ImageWidth  = assessment.ImageWidth;
            ImageHeight = assessment.ImageHeight;
            ReassignPinNumbers();
            GroupPinsByCapability();
            GroupCapabilities(); 
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading assessment: {ex.Message}";
        }
        
        Console.WriteLine($"Number of Fields: {groupedCapabilities.Count}");
        foreach (var fieldGroup in groupedCapabilities)
        {
            Console.WriteLine($"Field: {fieldGroup.Field}, Domains Count: {fieldGroup.Domains.Count}");
        }
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (assessment?.SolutionDesignImagePath != null && dotNetRef == null)
        {
            dotNetRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("resizeHandler.init", imageContainer, dotNetRef);
        }
    }
    
    [JSInvokable]
    public void OnResized(double width, double height)
    {
        ImageWidth  = width;
        ImageHeight = height;

        // update your in‑memory model so Save/Submit will persist it:
        assessment.ImageWidth  = width;
        assessment.ImageHeight = height;
    }

    private void GroupPinsByCapability()
    {
        groupedPins = assessment.Pins
            .GroupBy(p => p.CapabilityId)
            .Select(g => new GroupedPin
            {
                CapabilityName = g.First().Capability.CapabilityName,
                Pins = g.ToList()
            })
            .ToList();
    }

    private void GroupCapabilities()
    {
        groupedCapabilities = assessment.Capabilities
            .GroupBy(c => c.Field)
            .Select(fieldGroup => new GroupedCapabilitiesByField
            {
                Field = fieldGroup.Key,
                Domains = fieldGroup.GroupBy(c => c.Domain)
                    .Select(domainGroup => new GroupedCapabilitiesByDomain
                    {
                        Domain = domainGroup.Key,
                        Capabilities = domainGroup.ToList()
                    }).ToList()
            }).ToList();
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            if (file != null)
            {
                var fileName = $"{Guid.NewGuid()}{Path.GetExtension(file.Name)}";
                var filePath = Path.Combine("wwwroot", "uploads", fileName);
                Directory.CreateDirectory(Path.GetDirectoryName(filePath));
                using var stream = new FileStream(filePath, FileMode.Create);
                await file.OpenReadStream().CopyToAsync(stream);
                assessment.SolutionDesignImagePath = $"/uploads/{fileName}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error uploading file: {ex.Message}";
        }
    }

    private async Task AddPinForCapability(Capability cap)
    {
        var newPin = new Pin
        {
            Id = Guid.NewGuid().ToString(),
            AssessmentId = assessment.Id,
            CapabilityId = cap.Id,
            Capability = cap,
            X = 100,
            Y = 100,
            Width = 20,
            Height = 20
        };
        assessment.Pins.Add(newPin);
        ReassignPinNumbers();
        GroupPinsByCapability();
        await pinsGrid.Reload();
    }

    private void UpdatePinPosition(Pin pin, (double X, double Y) coords)
    {
        pin.X = coords.X;
        pin.Y = coords.Y;
    }

    private async Task RemovePin(Pin pin)
    {
        assessment.Pins.Remove(pin);
        ReassignPinNumbers();
        GroupPinsByCapability();
        await pinsGrid.Reload();
    }

    private async Task SaveAssessment()
    {
        try
        {
            
            var size = await JS.InvokeAsync<Size>("resizeHelper.getSize", imageContainer);

            // 2) update our model
            assessment.ImageWidth  = size.width;
            assessment.ImageHeight = size.height;
            await AssessmentService.UpdateAssessmentAsync(assessment);
            errorMessage = "Saved successfully.";
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving assessment: {ex.Message}";
        }
    }

    private async Task SubmitAssessment()
    {
        try
        {
            var size = await JS.InvokeAsync<Size>("resizeHelper.getSize", imageContainer);
            assessment.ImageWidth  = size.width;
            assessment.ImageHeight = size.height;
            await AssessmentService.UpdateAssessmentAsync(assessment);
            await AssessmentService.SubmitAssessmentAsync(assessment.Id, UserService.Email);
            NavigationManager.NavigateTo("/assessments", forceLoad: true);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error submitting assessment: {ex.Message}";
        }
    }

    private void BackToAssessmentList()
    {
        NavigationManager.NavigateTo("/assessments", forceLoad: true);
    }

    private void ReassignPinNumbers()
    {
        for (int i = 0; i < assessment.Pins.Count; i++)
        {
            assessment.Pins[i].DisplayNumber = i + 1;
        }
    }


    private void OnChange(int index)
    {
        currentTabIndex = index;
    }
    
    private class GroupedPin
    {
        public string CapabilityName { get; set; }
        public List<Pin> Pins { get; set; }
    }

    public class GroupedCapabilitiesByField
    {
        public string Field { get; set; }
        public List<GroupedCapabilitiesByDomain> Domains { get; set; }
    }

    public class GroupedCapabilitiesByDomain
    {
        public string Domain { get; set; }
        public List<Capability> Capabilities { get; set; }
    }
    public record Size(int width, int height);
}
<style>
    .pin-normal { background-color: #002337; }
    .unselectable { user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; -o-user-select: none; }
    .rz-button.rz-primary.rz-shade-default {
        background-color: #00436a;
    }
    .rz-button.rz-success.rz-shade-default {
        background-color: #006db9;
    }

    .rz-button.rz-secondary.rz-shade-default {
    background-color: #00436a;
    }
    
    .rz-button.rz-success {
        background-color: #006db9;
    }
    .rz-button.rz-danger.rz-shade-default {
        background-color: #f0f7fa;
        color: black;
    }
    .rz-button.rz-danger {
        background-color: #f0f7fa;
        color: black;
    }
    .rz-tabview-title {
        color: #00436a;
    }

    .rz-tabview.rz-tabview-top > .rz-tabview-nav .rz-tabview-selected {
        border-bottom: 2px solid #00436a;
    }

    :root {
        --rz-on-primary-lighter: #00436a;
        --rz-primary: #00436a;
    }

    .resizable-image-container {
        position: relative;
        border: 1px solid #ccc;
        overflow: hidden;   /* needed for native resize handle */
        resize: both;     /* magic: allows drag‑to‑resize */

        min-width: 200px;
        min-height: 200px;
    }

    .resizable-image {
        display: block;
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    .pin-normal {
        width:       20px;
        height:      20px;
        border-radius: 50%;
        display:     flex;
        align-items: center;
        justify-content: center;
        background-color: #002337;
        color:       white;
        font-weight: bold;
        user-select: none;
    }

    .unselectable {
        user-select: none;
    }
</style>

